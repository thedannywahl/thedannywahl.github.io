<!doctype html><html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Rolling Database Backups</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="shortcut icon" href="../favicon.ico">

    <link rel="stylesheet" type="text/css" href="../assets/css/screen.css?v=ad6e4698fb">

    <link rel="canonical" href="http://iyware.com/rolling-database-backups/">
    
    <meta property="og:site_name" content="iyWare">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Rolling Database Backups">
    <meta property="og:description" content="A few weeks back I decided to try to frustrate myself beyond belief by trying to write a bash script that would (among other things) dump a database every hour.  That idea quickly evolved to keeping the older backups, which...">
    <meta property="og:url" content="http://iyware.com/rolling-database-backups/">
    <meta property="article:published_time" content="2011-04-29T13:14:35.000Z">
    <meta property="article:modified_time" content="2013-10-08T21:03:55.000Z">
    <meta property="article:tag" content="Bash">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="MySQL">
    <meta property="article:tag" content="Postgres">
    <meta property="article:tag" content="Script">
    <meta property="article:tag" content="Ubuntu">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Rolling Database Backups">
    <meta name="twitter:description" content="A few weeks back I decided to try to frustrate myself beyond belief by trying to write a bash script that would (among other things) dump a database every hour.  That idea quickly evolved to keeping the older backups, which...">
    <meta name="twitter:url" content="http://iyware.com/rolling-database-backups/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "iyWare",
    "author": {
        "@type": "Person",
        "name": "Danny Wahl",
        "image": "http://iyware.com/content/images/2015/01/me.jpg",
        "url": "http://iyware.com/author/danny",
        "sameAs": null
    },
    "headline": "Rolling Database Backups",
    "url": "http://iyware.com/rolling-database-backups/",
    "datePublished": "2011-04-29T13:14:35.000Z",
    "dateModified": "2013-10-08T21:03:55.000Z",
    "keywords": "Bash, Linux, MySQL, Postgres, Script, Ubuntu",
    "description": "A few weeks back I decided to try to frustrate myself beyond belief by trying to write a bash script that would (among other things) dump a database every hour.  That idea quickly evolved to keeping the older backups, which..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="iyWare" href="http://iyware.com/rss/">
</head>
<body class="post-template tag-bash tag-linux tag-mysql tag-postgres tag-script tag-ubuntu">

    


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="http://iyware.com">Home</a>
        <a class="subscribe-button icon-feed" href="http://iyware.com/rss/">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-bash tag-linux tag-mysql tag-postgres tag-script tag-ubuntu">

        <header class="post-header">
            <h1 class="post-title">Rolling Database Backups</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2011-04-29">29 April 2011</time>  on <a href="../tag/bash/">Bash</a>, <a href="../tag/linux/">Linux</a>, <a href="../tag/mysql/">MySQL</a>, <a href="../tag/postgres/">Postgres</a>, <a href="../tag/script/">Script</a>, <a href="../tag/ubuntu/">Ubuntu</a>
            </section>
        </header>

        <section class="post-content">
            <p>A few weeks back I decided to try to frustrate myself beyond belief by trying to write a bash script that would (among other things) dump a database every hour.  That idea quickly evolved to keeping the older backups, which turned into setting a cap on the maximum amount of old backups to keep, which then added needing to know which backup was which.  If you’re confused reading this, welcome to my world trying to write it.</p>

<p>I was eventually able to write it (for PostgreSQL) and then port it to MySQL – acutally fairly easily – and in the process find out about some <a href="http://bugs.mysql.com/bug.php?id=17627">more limitations of MySQL</a>.  So for anyone looking to do something similar to what I wanted, here’s the scripts, followed by some notes.  I’m planning on doing a writeup of my entire script sometime – as the DB backup is just a small (albeit the most complex) part of it.</p>

<h3 id="postgresql">PostgreSQL</h3>

<p>You’ll notice by looking at this script that there aren’t any passwords involved, and that’s because it relies on reading the passwords from <a href="http://wiki.postgresql.org/wiki/Pgpass">.pgpass</a>.  You’ll also notice if you try to run the script that it complains you need root.  The reason for that is that I use root’s .pgpass file to store the passwords rather than the normal user just for a layer of security – as somebody that gets access to my standard account can’t just go grab my DB passwords and walk away – it is clear text after all.  You could drop the root check and move the pgpass file to ~ if you’re feeling lucky.</p>

<h3 id="mysql">MySQL</h3>

<p>This script is very very similar to the Postgres one – and that’s because it was ported from the Postgres script.  The main difference is that the database owner array is gone, and that’s because my.cnf only supports one account – so you need a credential set that has access to all of your databases you want to dump, e.g. Root.</p>

<h3 id="notes">Notes</h3>

<p>Well those are the scripts, and they should look pretty straight-forward, it loops through your databases that are associated with a domain, and dumps them to a folder you specify for that domain.  E.g. domain<em>1</em>db would be dumped to /path/to/domain<em>1/path/to/backup, or example</em>db would be backed up to /var/www/example/backup if that was where it was really stored. Your databases are also named with the regex you define for <code>$shore_date</code> which by default is <code>YYMMDD-HH.##.ext</code> the <code>##</code> is <code>00-$dbcount</code> (default is 23) 00 is the newest dump and 23 is the oldest. Anything older than that gets deleted.</p>
			<div id="disqus_thread"></div>
				<script type="text/javascript">
					/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
					var disqus_shortname = 'iyware'; // required: replace example with your forum shortname
					/* * * DON'T EDIT BELOW THIS LINE * * */
					(function() {
						var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
						dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
						(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
					})();
					</script>
					<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="../author/danny/" style="background-image: url(../content/images/2015/01/me.jpg)"><span class="hidden">Danny Wahl's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="../author/danny/">Danny Wahl</a></h4>

                    <p>My name is Danny Wahl and I provide Ed Tech consulting to international schools in the APAC region. I dabble in writing, programming, design, and ukulele playing.</p>
                <div class="author-meta">
                    
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Rolling%20Database%20Backups&amp;url=http://iyware.com/rolling-database-backups/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://iyware.com/rolling-database-backups/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://iyware.com/rolling-database-backups/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>

    </article>

</main>



    <footer class="site-footer clearfix">
         <section class="copyright"><a href="http://iyware.com">iyWare</a> © 2015</section>
         <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>

    <script src="../public/jquery.js?v=ad6e4698fb"></script>

    <script type="text/javascript" src="../assets/js/jquery.fitvids.js?v=ad6e4698fb"></script>
    <script type="text/javascript" src="../assets/js/index.js?v=ad6e4698fb"></script>

	<link rel="stylesheet" type="text/css" href="../assets/css/prism.min.css?v=ad6e4698fb">
	
    <script type="text/javascript" src="../assets/js/prism.min.js?v=ad6e4698fb"></script>

</body>
</html>
